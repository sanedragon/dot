#!/usr/bin/perl -w
use strict;

use File::Copy qw/ copy /;
use File::Find;
use File::Spec;
use Getopt::Long;
use List::MoreUtils qw/ uniq /;

my @sources = ( '/home/emily/Downloads' );
my @destinations = ( '/media/FC30-3DA9/My\ Files/Books/' );
my @extensions = ( 'epub' );

my $USAGE = <<USAGE;
This script just finds all the e-reader compatible files from one or more
directories and copies them to one or more other directories. By default,
e-reader compatible files means EPUB files with the extension '.epub'.

    -h|--help
        Display this message and exit.

    -s|--source <directory[,directory ...]>
        Directories to search for files. Default is to search
        '/home/emily/Downloads'.

    -d|--destination <directory[,directory ...]>
        Directories into which to copy the files. Default is to copy into
        '/media/FC30-3DA9/My\ Files/Books/'.

    -e|--extension <extension[,extension]>
        File extensions to search for, without leading patterns or dots. For
        example: 'pdf'. Default is 'epub'.
USAGE

my $help;

GetOptions(
    'source=s'      => \@sources,
    'destination=s' => \@destinations,
    'extensions=s'  => \@extensions,
    'help'          => \$help,
);

if ($help) {
    print $USAGE;
    return;
}

@sources = uniq(sort(split(/,/,join(',', @sources))));
@destinations = uniq(sort(split(/,/,join(',', @destinations))));
@extensions = uniq(sort(split(/,/,join(',', @extensions))));

File::Find::find
(
    {
        wanted => sub
        {
            for my $ext (@extensions)
            {
                if (/^.*\.$ext\z/si)
                {
                    for my $dest (@destinations)
                    {
                        my $old = $File::Find::name;
                        my $new = File::Spec->catfile($dest, $_);
                        print "Copying '$_' => '$dest'\n";
                        copy($old, $new) unless ( -e $new) or die "$!";
                    }
                }
            }
        },
        follow => 1,
    },
    @sources
);


